<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Centro de Masa: Pizza vs Dona — Canva Code</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{
    --bg:#0b1220;
    --panel:#0f172a;
    --panel-2:#111827;
    --accent:#22d3ee;
    --accent-2:#a78bfa;
    --wood-1:#b98153;
    --wood-2:#d3a678;
    --wood-3:#9c6b3f;
    --ok:#34d399;
    --warn:#f59e0b;
    --line:#94a3b8;
  }
  body{ background: radial-gradient(1200px 800px at 70% 10%, #0f1c33 0%, var(--bg) 60%); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;}
  /* Suavizado de arrastre */
  .dragging{ opacity:.85; transform: scale(1.06); }
  /* Línea con puntitos animados hacia el CM */
  .dashed-flow{
    stroke-dasharray:4 6;
    animation: dash 2s linear infinite;
  }
  @keyframes dash{ to { stroke-dashoffset: -200; } }
  .glass{ backdrop-filter: blur(10px); background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); }
  .btn{ transition: transform .12s ease, box-shadow .2s ease; }
  .btn:active{ transform: translateY(1px) scale(.98); }
  .shadow-soft{ box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);}
  .ring-focus:focus{ outline: none; box-shadow: 0 0 0 3px rgba(34,211,238,.35);}
  .chip{ transition: transform .15s ease, box-shadow .2s ease; }
  .chip:hover{ transform: translateY(-2px); }
  .tooltip{
    position: absolute; pointer-events:none; transform: translate(-50%, -140%);
    background: #0b1220; color: #e5e7eb; border:1px solid rgba(255,255,255,.12);
    border-radius:10px; padding:.25rem .5rem; font-size:.75rem; white-space:nowrap;
  }
  /* Export feedback */
  .toast{ animation: toast 2.2s ease forwards;}
  @keyframes toast{
    0%{ opacity:0; transform: translateY(8px); }
    10%,85%{ opacity:1; transform: translateY(0); }
    100%{ opacity:0; transform: translateY(-6px); }
  }
</style>
</head>
<body class="text-slate-200">
<div class="min-h-screen flex flex-col">
  <!-- Header -->
  <header class="px-6 md:px-10 py-5 flex items-center justify-between">
    <h1 class="text-xl md:text-2xl font-bold tracking-tight">
      Centro de masa — Pizza vs Dona
    </h1>
    <div class="flex items-center gap-3">
      <button id="exportPNG" class="btn ring-focus px-3.5 py-2 rounded-lg bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-semibold">
        Exportar PNG
      </button>
      <button id="exportSVG" class="btn ring-focus px-3.5 py-2 rounded-lg bg-violet-400/90 hover:bg-violet-300 text-slate-900 font-semibold">
        Exportar SVG
      </button>
    </div>
  </header>

  <main class="flex-1 px-6 md:px-10 pb-10">
    <div class="grid grid-cols-1 xl:grid-cols-[320px,1fr,320px] gap-6">
      <!-- Panel izquierdo: Selector y HUD -->
      <aside class="glass rounded-2xl p-5 shadow-soft">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold">Escenario</h2>
          <span class="text-xs text-slate-400">Intercambia base y toppings</span>
        </div>

        <div class="space-y-3">
          <label class="block text-sm mb-1 text-slate-300">Elegir base</label>
          <div class="flex gap-2">
            <button id="btnPizza" class="btn basis-1/2 px-3 py-2 rounded-lg border border-slate-700 bg-slate-800/60 hover:bg-slate-700/60 font-semibold">
              Pizza
            </button>
            <button id="btnDona" class="btn basis-1/2 px-3 py-2 rounded-lg border border-slate-700 bg-slate-800/60 hover:bg-slate-700/60 font-semibold">
              Dona
            </button>
          </div>

          <div class="mt-4">
            <label class="block text-sm mb-1 text-slate-300">Masa base</label>
            <div class="flex items-center gap-2">
              <input id="massBase" type="number" step="0.01" class="ring-focus w-28 px-3 py-2 rounded-lg bg-slate-900 border border-slate-700" />
              <span class="text-slate-400 text-sm">kg</span>
              <button id="applyMass" class="btn px-3 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold">Aplicar</button>
            </div>
            <p id="baseLabel" class="text-xs mt-2 text-slate-400">Masa base: 0.70 kg</p>
          </div>
        </div>

        <hr class="my-5 border-slate-700/60">

        <div>
          <h3 class="font-semibold mb-3">HUD</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span>Total masa</span>
              <span id="hudMass" class="font-semibold text-emerald-400">0.70 kg</span>
            </div>
            <div class="flex justify-between">
              <span>CM X</span>
              <span id="hudX" class="font-semibold text-cyan-300">0.00</span>
            </div>
            <div class="flex justify-between">
              <span>CM Y</span>
              <span id="hudY" class="font-semibold text-cyan-300">0.00</span>
            </div>
          </div>
          <p class="text-xs text-slate-400 mt-3">Arrastra ingredientes a la base. Las líneas conectan cada ingrediente con el centro de masa.</p>
        </div>
      </aside>

      <!-- Lienzo central -->
      <section class="relative rounded-2xl overflow-hidden shadow-soft">
        <!-- Superficie de madera -->
        <div class="absolute inset-0">
          <svg viewBox="0 0 1920 1080" preserveAspectRatio="xMidYMid slice" class="w-full h-full block">
            <defs>
              <linearGradient id="woodGrad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0" stop-color="#d8b48e"/>
                <stop offset="1" stop-color="#a67c52"/>
              </linearGradient>
              <pattern id="woodTexture" width="120" height="120" patternUnits="userSpaceOnUse">
                <rect width="120" height="120" fill="url(#woodGrad)"/>
                <path d="M0,30 Q30,10 60,30 T120,30 M0,90 Q30,70 60,90 T120,90" stroke="#8f6b45" stroke-opacity=".35" stroke-width="3" fill="none"/>
                <path d="M0,60 Q20,80 40,60 T80,60 T120,60" stroke="#815e3e" stroke-opacity=".25" stroke-width="2" fill="none"/>
              </pattern>
            </defs>
            <rect width="1920" height="1080" fill="url(#woodTexture)"/>
            <!-- Vignette -->
            <rect width="1920" height="1080" fill="url(#vg)" opacity=".35"/>
            <defs>
              <radialGradient id="vg" cx="50%" cy="40%" r="80%">
                <stop offset="40%" stop-color="#000" stop-opacity="0"/>
                <stop offset="100%" stop-color="#000" stop-opacity=".35"/>
              </radialGradient>
            </defs>
          </svg>
        </div>

        <!-- Área interactiva (SVG) -->
        <div class="relative">
          <svg id="scene" viewBox="0 0 1200 800" class="w-full h-[68vh] md:h-[72vh] 2xl:h-[76vh] block">
            <!-- Base: pizza o dona -->
            <defs>
              <!-- Sombras suaves -->
              <filter id="softShadow" x="-30%" y="-30%" width="160%" height="160%">
                <feDropShadow dx="0" dy="14" stdDeviation="18" flood-color="#000" flood-opacity=".35"/>
              </filter>

              <!-- Iconos ingredientes (vectoriales, sin img) -->
              <g id="icon-sprinkles">
                <g>
                  <rect x="-8" y="-2" width="16" height="4" rx="2" fill="#ef4444"/>
                  <rect x="-2" y="-8" width="4" height="16" rx="2" fill="#f59e0b"/>
                  <rect x="6" y="-6" width="12" height="4" rx="2" fill="#22c55e"/>
                  <rect x="-14" y="6" width="10" height="4" rx="2" fill="#3b82f6"/>
                </g>
              </g>
              <g id="icon-glaze">
                <path d="M-16 6 C-12 2 -8 2 -4 6 C0 10 4 10 8 6 C12 2 16 2 20 6 L20 14 L-16 14Z" fill="#f9a8d4"/>
                <circle cx="-8" cy="8" r="2" fill="#f472b6"/>
                <circle cx="4" cy="10" r="2" fill="#f472b6"/>
              </g>
              <g id="icon-pepperoni">
                <circle r="12" fill="#b91c1c"/>
                <circle r="3" cx="-5" cy="-3" fill="#7f1d1d"/>
                <circle r="3" cx="4" cy="2" fill="#7f1d1d"/>
              </g>
              <g id="icon-olive">
                <ellipse rx="10" ry="7" fill="#111827" stroke="#10b981" stroke-width="2"/>
                <circle r="2" cx="3" cy="0" fill="#10b981"/>
              </g>
              <g id="icon-basil">
                <path d="M0 -12 C8 -10 10 -4 0 10 C-10 -4 -8 -10 0 -12Z" fill="#16a34a"/>
                <path d="M0 -12 L0 10" stroke="#065f46" stroke-width="2" />
              </g>
              <g id="icon-choco">
                <rect x="-10" y="-10" width="20" height="20" rx="3" fill="#6b3a1e"/>
                <path d="M-6 -6 L6 6 M6 -6 L-6 6" stroke="#3f1f0f" stroke-width="2"/>
              </g>
            </defs>

            <!-- Grupo base con sombra -->
            <g id="baseGroup" transform="translate(600,400)" filter="url(#softShadow)">
              <!-- Pizza (disco) -->
              <g id="basePizza">
                <circle r="220" fill="#d9a86c"/>
                <circle r="205" fill="#eab308"/>
                <circle r="195" fill="#ef4444" opacity=".9"/>
              </g>
              <!-- Dona (anillo) -->
              <g id="baseDona">
                <circle r="200" fill="#f3cda3"/>
                <circle r="105" fill="#0b1220"/>
                <circle r="95" fill="#f3cda3"/>
              </g>
            </g>

            <!-- Etiqueta masa base -->
            <g id="baseMassLabel" transform="translate(600,140)">
              <rect x="-110" y="-26" width="220" height="36" rx="10" fill="#0b1220" stroke="#334155"/>
              <text text-anchor="middle" dominant-baseline="middle" fill="#e5e7eb" font-size="16" font-weight="600">Masa base: 0.70 kg</text>
            </g>

            <!-- Marcador CM -->
            <g id="cmGroup" transform="translate(600,400)">
              <circle r="8" fill="#22d3ee"/>
              <circle r="18" fill="none" stroke="#22d3ee" stroke-width="2" opacity=".8"/>
              <text id="cmLabel" x="24" y="-10" fill="#e5e7eb" font-size="14">Centro de masa</text>
            </g>

            <!-- Líneas a ingredientes -->
            <g id="linesLayer"></g>

            <!-- Ingredientes colocados -->
            <g id="placedLayer"></g>

            <!-- Zona de ayuda / guía -->
            <g id="hint" opacity=".9">
              <rect x="280" y="640" width="640" height="90" rx="14" fill="#0b1220" stroke="#334155"/>
              <text x="600" y="685" text-anchor="middle" font-size="18" fill="#e5e7eb" font-weight="600">Arrastra ingredientes a la base</text>
              <text x="600" y="712" text-anchor="middle" font-size="13" fill="#94a3b8">El centro de masa se moverá suavemente y verás líneas de conexión</text>
            </g>
          </svg>
        </div>
      </section>

      <!-- Panel derecho: Ingredientes dinámicos -->
      <aside class="glass rounded-2xl p-5 shadow-soft">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Ingredientes</h2>
          <div class="flex items-center gap-2 text-xs text-slate-400">
            <span>Tamaño</span>
            <select id="sizeSelect" class="ring-focus bg-slate-900 border border-slate-700 rounded-lg px-2 py-1">
              <option value="S">S</option>
              <option value="M" selected>M</option>
              <option value="L">L</option>
            </select>
          </div>
        </div>
        <div id="palette" class="grid grid-cols-2 gap-3"></div>
        <p class="text-xs text-slate-400 mt-4">Cada ficha muestra su masa en gramos. Puedes arrastrar varias copias.</p>
      </aside>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden toast px-4 py-2 rounded-lg bg-black/80 text-slate-100 border border-slate-700">Exportado</div>
</div>

<script>
/* ------------------ Estado ------------------ */
const STATE = {
  scenario: 'pizza', // 'pizza' | 'dona'
  baseMassKg: { pizza: 0.70, dona: 0.07 },
  placed: [], // {id, type, x, y, massG, iconId}
  sizes: { S: 20, M: 28, L: 36 }, // radio visual del círculo-ficha
  currentSize: 'M',
  nextId: 1,
  cm: { x: 600, y: 400 }, // posición actual del CM
  targetCM: { x: 600, y: 400 },
  animStart: 0,
  animDuration: 400
};

// Ingredientes por escenario
const INGREDIENTS = {
  pizza: [
    { key:'pepperoni', label:'Pepperoni', massG:12, icon:'#icon-pepperoni', color:'#fecaca' },
    { key:'olive', label:'Aceituna', massG:6, icon:'#icon-olive', color:'#99f6e4' },
    { key:'basil', label:'Albahaca', massG:4, icon:'#icon-basil', color:'#bbf7d0' },
    { key:'sauce', label:'Salsa extra', massG:10, icon:'#icon-glaze', color:'#fda4af' }
  ],
  dona: [
    { key:'sprinkles', label:'Sprinkles', massG:2, icon:'#icon-sprinkles', color:'#fef08a' },
    { key:'glaze', label:'Glaseado', massG:14, icon:'#icon-glaze', color:'#fbcfe8' },
    { key:'choco', label:'Chocolate', massG:8, icon:'#icon-choco', color:'#fca5a5' },
    { key:'olive', label:'Aceituna', massG:6, icon:'#icon-olive', color:'#99f6e4' } // travieso pero didáctico
  ]
};

// Elementos DOM
const scene = document.getElementById('scene');
const baseGroup = document.getElementById('baseGroup');
const basePizza = document.getElementById('basePizza');
const baseDona = document.getElementById('baseDona');
const baseMassLabel = document.getElementById('baseMassLabel').querySelector('text');
const hudMass = document.getElementById('hudMass');
const hudX = document.getElementById('hudX');
const hudY = document.getElementById('hudY');
const cmGroup = document.getElementById('cmGroup');
const cmLabel = document.getElementById('cmLabel');
const linesLayer = document.getElementById('linesLayer');
const placedLayer = document.getElementById('placedLayer');
const hint = document.getElementById('hint');
const palette = document.getElementById('palette');
const btnPizza = document.getElementById('btnPizza');
const btnDona  = document.getElementById('btnDona');
const massBaseInput = document.getElementById('massBase');
const baseLabel = document.getElementById('baseLabel');
const applyMass = document.getElementById('applyMass');
const sizeSelect = document.getElementById('sizeSelect');
const exportPNG = document.getElementById('exportPNG');
const exportSVG = document.getElementById('exportSVG');
const toast = document.getElementById('toast');

/* ------------------ Utilidades ------------------ */
function setButtonsActive(){
  const active = 'bg-cyan-500 text-slate-900 border-cyan-400';
  const inactive = 'bg-slate-800/60 text-slate-200 border-slate-700 hover:bg-slate-700/60';
  btnPizza.className = 'btn basis-1/2 px-3 py-2 rounded-lg border font-semibold ' + (STATE.scenario==='pizza'?active:inactive);
  btnDona.className  = 'btn basis-1/2 px-3 py-2 rounded-lg border font-semibold ' + (STATE.scenario==='dona'?active:inactive);
}
function fmtKg(v){ return v.toFixed(2)+' kg'; }
function showToast(msg){
  toast.textContent = msg; toast.classList.remove('hidden'); toast.classList.add('toast');
  setTimeout(()=>toast.classList.add('hidden'), 2200);
}
function svgPoint(evt){
  const pt = scene.createSVGPoint();
  pt.x = evt.clientX; pt.y = evt.clientY;
  const m = scene.getScreenCTM().inverse();
  return pt.matrixTransform(m);
}
function insideBase(x,y){
  // Pizza: disco de r<=195 aprovechable (salsa)
  // Dona: anillo entre r in [105,200]
  const cx=600, cy=400;
  const dx=x-cx, dy=y-cy, r=Math.hypot(dx,dy);
  if(STATE.scenario==='pizza') return r<=195;
  return r>=110 && r<=200;
}

/* ------------------ Render paleta ------------------ */
function renderPalette(){
  palette.innerHTML = '';
  const list = INGREDIENTS[STATE.scenario];
  list.forEach((it, idx)=>{
    const wrap = document.createElement('div');
    wrap.className='chip relative rounded-xl border border-slate-700 bg-slate-900/50 px-3 py-3 flex items-center gap-3 cursor-grab active:cursor-grabbing';
    wrap.setAttribute('data-key', it.key);
    wrap.setAttribute('data-mass', it.massG);
    wrap.setAttribute('data-icon', it.icon);
    wrap.setAttribute('data-color', it.color);

    // SVG mini
    const sizeMap = {S:22, M:28, L:36};
    const r = sizeMap[STATE.currentSize];
    wrap.innerHTML = `
      <div class="shrink-0 grid place-items-center w-12 h-12 rounded-full" style="background: radial-gradient(circle at 35% 30%, ${it.color}, rgba(255,255,255,0.06))">
        <svg viewBox="-24 -24 48 48" width="${r}" height="${r}">
          <use href="${it.icon}"></use>
        </svg>
      </div>
      <div class="flex-1 min-w-0">
        <div class="text-sm font-semibold">${it.label}</div>
        <div class="text-xs text-slate-400">masa: ${it.massG} g</div>
      </div>
      <button class="btn px-2 py-1 text-xs rounded-md bg-slate-800 hover:bg-slate-700 border border-slate-700">Añadir</button>
    `;
    // Drag from palette
    wrap.addEventListener('mousedown', startGhostDrag);
    // Quick add button
    wrap.querySelector('button').addEventListener('click', ()=>{
      // coloca en una posición aleatoria válida sobre la base
      const pos = randomBasePoint();
      addPlaced(it, pos.x, pos.y);
    });
    palette.appendChild(wrap);
  });
}

/* ------------------ Escenario/Base ------------------ */
function setScenario(scn){
  if(STATE.scenario===scn) return;
  STATE.scenario = scn;
  setButtonsActive();

  // Cambiar base visible
  basePizza.style.display = (scn==='pizza')?'block':'none';
  baseDona.style.display  = (scn==='dona') ?'block':'none';

  // Actualizar masa base por escenario
  massBaseInput.value = STATE.baseMassKg[scn].toFixed(2);
  baseMassLabel.textContent = 'Masa base: ' + fmtKg(STATE.baseMassKg[scn]);
  baseLabel.textContent = 'Masa base: ' + fmtKg(STATE.baseMassKg[scn]);

  // Limpiar ingredientes colocados y líneas
  STATE.placed = [];
  linesLayer.innerHTML = '';
  placedLayer.innerHTML = '';
  hint.style.display = 'block';

  // Resetear CM al centro de la base
  setCMTarget(600,400,true);

  // Re-render paleta con toppings del escenario
  renderPalette();
  updateHUD();
}

/* ------------------ Colocar ingredientes ------------------ */
function addPlaced(item, x, y){
  if(!insideBase(x,y)) return; // no colocar fuera
  hint.style.display = 'none';
  const id = 'p'+(STATE.nextId++);
  const massG = item.massG;
  const group = document.createElementNS('http://www.w3.org/2000/svg','g');
  group.setAttribute('transform', `translate(${x},${y})`);
  group.setAttribute('data-id', id);
  group.setAttribute('cursor','grab');

  const r = {S:12, M:14, L:17}[STATE.currentSize];

  // círculo ficha + icono + etiqueta
  const bg = document.createElementNS('http://www.w3.org/2000/svg','circle');
  bg.setAttribute('r', r+8);
  bg.setAttribute('fill', '#0b1220');
  bg.setAttribute('stroke', '#334155');
  bg.setAttribute('stroke-width','2');
  group.appendChild(bg);

  const disk = document.createElementNS('http://www.w3.org/2000/svg','circle');
  disk.setAttribute('r', r+2);
  disk.setAttribute('fill', 'url(#grad-'+id+')');
  disk.setAttribute('stroke', '#00000022');
  group.appendChild(disk);

  // Gradiente radial único para brillo
  const defs = scene.querySelector('defs');
  const grad = document.createElementNS('http://www.w3.org/2000/svg','radialGradient');
  grad.setAttribute('id','grad-'+id);
  grad.setAttribute('cx','35%'); grad.setAttribute('cy','30%');
  grad.innerHTML = `<stop offset="0%" stop-color="${item.color}"/><stop offset="100%" stop-color="rgba(255,255,255,0.06)"/>`;
  defs.appendChild(grad);

  const icon = document.createElementNS('http://www.w3.org/2000/svg','use');
  icon.setAttribute('href', item.icon);
  icon.setAttribute('x', '0'); icon.setAttribute('y','0');
  icon.setAttribute('transform', 'translate(0,0) scale(1)');
  icon.setAttribute('pointer-events','none');
  group.appendChild(icon);

  const label = document.createElementNS('http://www.w3.org/2000/svg','text');
  label.setAttribute('y', r+24);
  label.setAttribute('text-anchor','middle');
  label.setAttribute('fill','#e5e7eb');
  label.setAttribute('font-size','12');
  label.textContent = `masa: ${massG} g`;
  group.appendChild(label);

  // Línea al CM
  const line = document.createElementNS('http://www.w3.org/2000/svg','line');
  line.setAttribute('x1', x); line.setAttribute('y1', y);
  line.setAttribute('x2', STATE.cm.x); line.setAttribute('y2', STATE.cm.y);
  line.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--line') || '#94a3b8');
  line.setAttribute('stroke-width','2');
  line.setAttribute('class','dashed-flow');
  line.setAttribute('data-link', id);
  linesLayer.appendChild(line);

  // Eventos de arrastre dentro del lienzo
  let dragging = false;
  group.addEventListener('mousedown', (e)=>{
    dragging = true; group.classList.add('dragging');
    e.stopPropagation();
  });
  window.addEventListener('mousemove', (e)=>{
    if(!dragging) return;
    const p = svgPoint(e);
    const nx = Math.max(120, Math.min(1080, p.x));
    const ny = Math.max(100, Math.min(740, p.y));
    group.setAttribute('transform', `translate(${nx},${ny})`);
    // Actualizar extremo de línea
    const l = linesLayer.querySelector(`line[data-link="${id}"]`);
    l.setAttribute('x1', nx); l.setAttribute('y1', ny);
  });
  window.addEventListener('mouseup', (e)=>{
    if(!dragging) return;
    dragging=false; group.classList.remove('dragging');
    const p = svgPoint(e);
    if(!insideBase(p.x,p.y)){
      // volver a su última posición válida (simple: eliminar)
      removeById(id);
      return;
    }
    // Actualiza estado con nueva posición
    const l = linesLayer.querySelector(`line[data-link="${id}"]`);
    l.setAttribute('x1', p.x); l.setAttribute('y1', p.y);
    const obj = STATE.placed.find(o=>o.id===id);
    if(obj){ obj.x=p.x; obj.y=p.y; }
    recomputeCM();
  });

  placedLayer.appendChild(group);
  STATE.placed.push({ id, type:item.key, x, y, massG, iconId:item.icon });
  recomputeCM();
}

/* ------------------ Cálculo del CM con animación ------------------ */
function recomputeCM(){
  const baseKg = STATE.baseMassKg[STATE.scenario];
  const baseG = baseKg*1000;
  // Base centrada en (600,400)
  let totalM = baseG;
  let sumX = 600*baseG;
  let sumY = 400*baseG;

  // Ingredientes
  STATE.placed.forEach(p=>{
    totalM += p.massG;
    sumX += p.x * p.massG;
    sumY += p.y * p.massG;
  });

  const nx = sumX/totalM;
  const ny = sumY/totalM;
  setCMTarget(nx, ny);
  updateHUD(totalM);
  // Actualizar líneas hacia el nuevo CM
  for(const line of linesLayer.querySelectorAll('line')){
    line.setAttribute('x2', STATE.cm.x);
    line.setAttribute('y2', STATE.cm.y);
  }
}

function setCMTarget(x,y, instant=false){
  STATE.targetCM = {x,y};
  if(instant){
    STATE.cm = {x,y};
    cmGroup.setAttribute('transform', `translate(${x},${y})`);
    cmLabel.setAttribute('x', 24);
    return;
  }
  STATE.animStart = performance.now();
  requestAnimationFrame(stepCM);
}

function stepCM(now){
  const t = Math.min(1, (now-STATE.animStart)/STATE.animDuration);
  const ease = t<0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2; // easeInOutCubic
  const x = STATE.cm.x + (STATE.targetCM.x - STATE.cm.x)*ease;
  const y = STATE.cm.y + (STATE.targetCM.y - STATE.cm.y)*ease;
  cmGroup.setAttribute('transform', `translate(${x},${y})`);
  // actualizar líneas destino en vivo
  for(const line of linesLayer.querySelectorAll('line')){
    line.setAttribute('x2', x);
    line.setAttribute('y2', y);
  }
  if(t<1){
    requestAnimationFrame(stepCM);
  } else {
    STATE.cm = { ...STATE.targetCM };
  }
}

/* ------------------ HUD ------------------ */
function updateHUD(totalMOverride){
  const baseKg = STATE.baseMassKg[STATE.scenario];
  const totalG = (totalMOverride ?? (baseKg*1000 + STATE.placed.reduce((a,p)=>a+p.massG,0)));
  const totalKg = totalG/1000;
  hudMass.textContent = totalKg.toFixed(2)+' kg';
  baseMassLabel.textContent = 'Masa base: ' + fmtKg(baseKg);
  baseLabel.textContent = 'Masa base: ' + fmtKg(baseKg);

  // Convertir coordenadas a un sistema relativo con origen en el centro (opcional, aquí mostramos SVG coords redondeadas)
  hudX.textContent = (STATE.targetCM.x-600).toFixed(2);
  hudY.textContent = (STATE.targetCM.y-400).toFixed(2);
}

/* ------------------ Drag desde paleta con fantasma ------------------ */
let ghost = null;
function startGhostDrag(e){
  const card = e.currentTarget;
  const icon = card.getAttribute('data-icon');
  const label = card.querySelector('.text-sm')?.textContent || 'Ingrediente';
  const massG = parseFloat(card.getAttribute('data-mass'));
  const color = card.getAttribute('data-color');

  const p = svgPoint(e);
  ghost = document.createElementNS('http://www.w3.org/2000/svg','g');
  ghost.setAttribute('opacity','.9');
  ghost.classList.add('dragging');

  const r = {S:12, M:14, L:17}[STATE.currentSize];

  const bg = document.createElementNS('http://www.w3.org/2000/svg','circle');
  bg.setAttribute('r', r+8); bg.setAttribute('fill', '#0b1220'); bg.setAttribute('stroke','#334155'); bg.setAttribute('stroke-width','2');
  const disk = document.createElementNS('http://www.w3.org/2000/svg','circle');
  disk.setAttribute('r', r+2); disk.setAttribute('fill', color);
  const use = document.createElementNS('http://www.w3.org/2000/svg','use');
  use.setAttribute('href', icon);

  const t = document.createElementNS('http://www.w3.org/2000/svg','text');
  t.setAttribute('y', r+24); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','12'); t.setAttribute('fill','#e5e7eb');
  t.textContent = `masa: ${massG} g`;

  ghost.appendChild(bg); ghost.appendChild(disk); ghost.appendChild(use); ghost.appendChild(t);
  placedLayer.appendChild(ghost);

  moveGhost(p.x,p.y);

  function moveGhost(x,y){
    ghost.setAttribute('transform', `translate(${x},${y})`);
    ghost.setAttribute('opacity', insideBase(x,y)? '1' : '.6');
  }

  function onMove(ev){ const sp = svgPoint(ev); moveGhost(sp.x, sp.y); }
  function onUp(ev){
    window.removeEventListener('mousemove', onMove);
    window.removeEventListener('mouseup', onUp);
    const sp = svgPoint(ev);
    placedLayer.removeChild(ghost); ghost=null;
    if(insideBase(sp.x, sp.y)){
      addPlaced({ key: card.getAttribute('data-key'), massG, icon, color }, sp.x, sp.y);
    }
  }
  window.addEventListener('mousemove', onMove);
  window.addEventListener('mouseup', onUp);
}

/* ------------------ Borrar ingrediente (doble click) ------------------ */
function removeById(id){
  // eliminar visual
  const g = placedLayer.querySelector(`g[data-id="${id}"]`);
  if(g) placedLayer.removeChild(g);
  const l = linesLayer.querySelector(`line[data-link="${id}"]`);
  if(l) linesLayer.removeChild(l);
  // eliminar estado
  const i = STATE.placed.findIndex(o=>o.id===id);
  if(i>=0) STATE.placed.splice(i,1);
  recomputeCM();
}
placedLayer.addEventListener('dblclick', (e)=>{
  const g = e.target.closest('g[data-id]');
  if(g){ removeById(g.getAttribute('data-id')); }
});


/* ------------------ Ajustes de UI ------------------ */
btnPizza.addEventListener('click', ()=> setScenario('pizza'));
btnDona.addEventListener('click', ()=> setScenario('dona'));

applyMass.addEventListener('click', ()=>{
  const v = parseFloat(massBaseInput.value);
  if(!isNaN(v) && v>0){
    STATE.baseMassKg[STATE.scenario] = v;
    baseLabel.textContent = 'Masa base: ' + fmtKg(v);
    baseMassLabel.textContent = 'Masa base: ' + fmtKg(v);
    recomputeCM();
  }
});

sizeSelect.addEventListener('change', (e)=>{
  STATE.currentSize = e.target.value;
  renderPalette();
});

/* ------------------ Ayudas ------------------ */
function randomBasePoint(){
  // Genera un punto dentro de la base, respetando pizza/disco o dona/anillo
  const cx=600, cy=400;
  if(STATE.scenario==='pizza'){
    const r = 190 * Math.sqrt(Math.random());
    const a = Math.random()*Math.PI*2;
    return { x: cx + r*Math.cos(a), y: cy + r*Math.sin(a) };
  } else {
    // anillo entre 115 y 195
    const r = Math.sqrt(Math.random())*(195-115)+115;
    const a = Math.random()*Math.PI*2;
    return { x: cx + r*Math.cos(a), y: cy + r*Math.sin(a) };
  }
}

/* ------------------ Init ------------------ */
function init(){
  // por defecto Pizza 0.70 kg y Dona 0.07 kg como pediste
  STATE.scenario = 'pizza';
  basePizza.style.display='block';
  baseDona.style.display='none';
  massBaseInput.value = STATE.baseMassKg.pizza.toFixed(2);
  baseLabel.textContent = 'Masa base: ' + fmtKg(STATE.baseMassKg.pizza);
  baseMassLabel.textContent = 'Masa base: ' + fmtKg(STATE.baseMassKg.pizza);
  setButtonsActive();
  renderPalette();
  updateHUD();
}
init();
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97f575540498fa30',t:'MTc1NzkxMTM1NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
